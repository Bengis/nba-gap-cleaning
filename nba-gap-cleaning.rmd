---
title: 'PRACTICA 2: LIMPIEZA Y VALIDACIÓN DE LOS DATOS'
author: "Jose Ignacio Bengoechea Isasa"
tuthor: "Mireia Calvo Gonzalez"
date: '`r format(Sys.Date(),"%e de %B %Y")`'
output:
  html_document:
    toc: yes
    number_sections: yes
    toc_depth: 2
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r load_libraries, include=FALSE}
library(knitr)
library(lubridate)
library(VIM)
library(stringr)
library(psych)
library(pROC)
```

Partimos de dos datasets, donde tenemos el total de minutos, partidos, puntos, rebotes, asistencias, tapones y robos efectuados por los jugadores de la NBA y las jugadores de la WNBA, que son la liga masuclina y femenina de baloncesto de Estados Unidos. Estos datos corresponden a la temporada 2016-17.

Nuestro objetivo es unificar estas fuentes en un unico dataset, limpiarlo, normalizarlo si es necesario, y establecer visualizaciones que nos permitan obtener información sobre la brecha salarial existente entre ambas ligas.

```{r, echo=TRUE}
# read data
nba_org <- read.csv("nba-stats_out.csv")
nba_org["sex"] <- NA
nba_org$sex<-0
wnba_org <- read.csv("wnba-stats_out.csv")
wnba_org["sex"] <- NA
wnba_org$sex<-1
t_nba <- rbind(nba_org, wnba_org)
n.var <- names(t_nba)
```

****
# Limpieza de datos
****

El fichero de datos contiene `r nrow(t_nba)` registros y  `r ncol(t_nba)` variables. 

Contiene `r length(which(t_nba$sex==0))` jugadores y  `r length(which(t_nba$sex==1))` jugadoras.

Las variables son `r toString(n.var)`.

## Selección de datos

De estas variables nos interesa eliminar las siguientes, ya que son campos calculados:

* slry/pts. Es el resultado de salario/puntos.
* slry/rbds. Es el resultado de salario/rebotes.
* slry/asts. Es el resultado de salario/asistencias.
* slry/stls. Es el resultado de salario/robos.
* slry/blks. Es el resultado de salario/tapones.

Estos campos se van a ver modificados en las transformaciones que vamos a ir realizando, por lo que no tiene sentido mantenerlos, sino establecerlos de nuevo tras las transformaciones de datos.

```{r, echo=TRUE}
t_nba<-t_nba[,-10:-14]
```

## Eliminación de valores nulos, outliers y fringeliers

En primer lugar vamos a ver la cantidad de valores nulos que existen por cada atributo.

* Player. Es el nombre del jugador, no es una variables numérica.
* Games. Partidos. Hay `r length(which(t_nba$games==0))` jugadores que no han jugado ningun partido.
* Minutes. Minutos. Hay `r length(which(t_nba$minutes==0))` jugadores que no han jugado ni un minuto.
* Points. Puntos. Hay `r length(which(t_nba$points==0))` jugadores que no han anotado.
* Rebds. Rebotes.Hay `r length(which(t_nba$rebds==0))` jugadores que no han reboteado.
* Assists. Asistencias.Hay `r length(which(t_nba$assists==0))` jugadores que no han asistido.
* Steals. Robos. Hay `r length(which(t_nba$steals==0))` jugadores que no han robado jugadas.
* Blocks. Tapones.Hay `r length(which(t_nba$blocks==0))` jugadores que no han taponado.
* Salary. Salario. Hay `r length(which(t_nba$salary==0))` jugadores que no tienen salario.
* Sex. Nos permite filtrar el sexo.

Aunque no se han limpiado los datos ni normalizado el modelo se ven una series de relaciones que son interesantes:

* Entre el número de minutos y partidos jugados la relación es lineal.

```{r, echo=TRUE}
t_nba_reduced<-t_nba[,-4:-10]
t_nba_reduced<-t_nba_reduced[,-1:-1]
pairs(t_nba_reduced)
```

* Entre el número de minutos jugados y los puntos la relación es lineal. 

```{r, echo=TRUE}
t_nba_reduced<-t_nba[,-5:-10]
t_nba_reduced<-t_nba_reduced[,-1:-2]
pairs(t_nba_reduced)
```

Esto me lleva a pensar que los minutos son un atributo esencial, si un jugador no juega obviamente no va a tener oportunidad de conseguir ninguna estadistica. 

Por otro lado, debemos tener en cuenta que tenemos dos origenes de datos distintos. 

* Los jugadores de la NBA juegan un máximo de 82 partidos por temporada.
* Las jugadoras de la WNBA juegan un máximo de 34 partidos por temporada.

Por lo que los valores estadisticos totales discriminan a las jugadoras, que no tendran la misma cantidad de puntos, ni de rebotes. 

Por lo que realizaremos los siguientes ajustes:

* Convertimos los atributos de estadisticas en tipo numérico.

```{r, echo=TRUE}
t_nba[2:9] <- lapply(t_nba[2:9], as.numeric)
```

* Se elimina la columna de total de partidos. 

```{r, echo=TRUE}
t_nba<-t_nba[which(t_nba$games!="0"),]
```

* Se dividen todos los estadisticos de productividad por los partidos jugados. Asi tenemos estadisticos por partido, de minutos, puntos, rebotes, asistencias, robos, tapones y salario.

```{r, echo=TRUE}
games<-t_nba[,2]
for(i in 2:9) {
    t_nba[,i] <- t_nba[,i]/games
}
```

* Se elimina la columna de total de partidos. 

```{r, echo=TRUE}
t_nba<-t_nba[,-2:-2]
```

* Eliminamos los registros de jugadores que no han jugado ningún minuto.

```{r, echo=TRUE}
t_nba<-t_nba[which(t_nba$minutes!="0"),]
```

* Eliminamos los registros de jugadores que tengan un número de minutos por partido que podamos catalogar como fringelier, es decir que se alejen 3 veces la desviación estandard de la media.
* Al haber eliminado los fringeliers habremos eliminado tambien los outliers.